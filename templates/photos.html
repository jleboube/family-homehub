{% extends "base.html" %}
{% block content %}
<div class="mx-auto">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold"><i class="fa-solid fa-images text-pink-600 mr-2"></i>Family Photo Gallery</h2>
        <button onclick="document.getElementById('uploadModal').classList.remove('hidden')" class="btn btn-primary">
            <i class="fa-solid fa-upload mr-2"></i>Upload Photos
        </button>
    </div>

    <!-- Album Filter -->
    <div class="card p-4 mb-6">
        <div class="flex flex-wrap gap-2">
            <button onclick="filterAlbum('all')" class="album-filter px-4 py-2 rounded-full bg-gray-200 hover:bg-blue-600 hover:text-white transition-all" data-album="all">
                <i class="fa-solid fa-layer-group mr-1"></i>All Photos
            </button>
            {% for album in albums %}
            <button onclick="filterAlbum('{{ album }}')" class="album-filter px-4 py-2 rounded-full bg-gray-200 hover:bg-blue-600 hover:text-white transition-all" data-album="{{ album }}">
                <i class="fa-solid fa-folder mr-1"></i>{{ album }}
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- Photo Grid -->
    <div id="photo-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {% for photo in photos %}
        <div class="photo-item card p-2 cursor-pointer hover:shadow-xl transition-all" data-album="{{ photo.album }}" onclick="openPhoto({{ photo.id }})">
            <img src="/photos/thumb/{{ photo.filename }}" alt="{{ photo.caption or 'Photo' }}" class="w-full h-48 object-cover rounded-lg mb-2">
            <div class="px-2">
                <p class="text-sm font-semibold truncate">{{ photo.caption or photo.filename }}</p>
                <p class="text-xs text-gray-500">{{ photo.upload_time.strftime('%b %d, %Y') }}</p>
                <p class="text-xs text-gray-400">by {{ photo.uploader }}</p>
            </div>
        </div>
        {% else %}
        <div class="col-span-full text-center py-12">
            <i class="fa-solid fa-images text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">No photos yet. Upload some to get started!</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg p-6 max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold"><i class="fa-solid fa-upload mr-2"></i>Upload Photos</h3>
            <button onclick="document.getElementById('uploadModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                <i class="fa-solid fa-times text-2xl"></i>
            </button>
        </div>
        <form method="POST" enctype="multipart/form-data" action="/photos/upload">
            <div class="mb-4">
                <label class="block font-semibold mb-2">Select Photos</label>
                <input type="file" name="photos" multiple accept="image/*" required class="w-full p-2 border rounded">
            </div>
            <div class="mb-4">
                <label class="block font-semibold mb-2">Album</label>
                <input type="text" name="album" list="albums" class="w-full p-2 border rounded" placeholder="Enter or select album">
                <datalist id="albums">
                    {% for album in albums %}
                    <option value="{{ album }}">
                    {% endfor %}
                </datalist>
            </div>
            <div class="mb-4">
                <label class="block font-semibold mb-2">Caption (Optional)</label>
                <input type="text" name="caption" class="w-full p-2 border rounded" placeholder="Add a caption">
            </div>
            <input type="hidden" name="uploader" id="uploader">
            <div class="flex gap-2">
                <button type="submit" class="btn btn-primary flex-1">Upload</button>
                <button type="button" onclick="document.getElementById('uploadModal').classList.add('hidden')" class="btn flex-1">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Photo Viewer Modal -->
<div id="photoViewer" class="hidden fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4">
    <button onclick="document.getElementById('photoViewer').classList.add('hidden')" class="absolute top-4 right-4 text-white text-3xl hover:text-gray-300">
        <i class="fa-solid fa-times"></i>
    </button>
    <div class="max-w-6xl w-full">
        <img id="viewerImage" src="" alt="" class="w-full h-auto rounded-lg shadow-2xl">
        <div class="text-white mt-4 text-center">
            <p id="viewerCaption" class="text-xl font-semibold mb-2"></p>
            <p id="viewerInfo" class="text-sm text-gray-300"></p>
        </div>
        <div class="flex justify-center gap-4 mt-4">
            <button onclick="deletePhoto(window.currentPhotoId)" class="btn btn-danger">
                <i class="fa-solid fa-trash mr-1"></i>Delete
            </button>
        </div>
    </div>
</div>

<script>
document.getElementById('uploader').value = localStorage.getItem('username');

function filterAlbum(album) {
    const items = document.querySelectorAll('.photo-item');
    const filters = document.querySelectorAll('.album-filter');

    filters.forEach(f => {
        f.classList.remove('bg-blue-600', 'text-white');
        if (f.dataset.album === album) {
            f.classList.add('bg-blue-600', 'text-white');
        }
    });

    items.forEach(item => {
        if (album === 'all' || item.dataset.album === album) {
            item.classList.remove('hidden');
        } else {
            item.classList.add('hidden');
        }
    });
}

function openPhoto(photoId) {
    window.currentPhotoId = photoId;
    fetch(`/photos/get/${photoId}`)
        .then(r => r.json())
        .then(data => {
            document.getElementById('viewerImage').src = '/photos/full/' + data.filename;
            document.getElementById('viewerCaption').textContent = data.caption || data.filename;
            document.getElementById('viewerInfo').textContent = `Uploaded by ${data.uploader} on ${data.upload_time}`;
            document.getElementById('photoViewer').classList.remove('hidden');
        });
}

function deletePhoto(photoId) {
    if (!confirm('Are you sure you want to delete this photo?')) return;

    const formData = new FormData();
    formData.append('user', localStorage.getItem('username'));

    fetch(`/photos/delete/${photoId}`, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
}

// Initialize first filter
filterAlbum('all');
</script>
{% endblock %}

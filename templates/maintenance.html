{% extends "base.html" %}
{% block content %}
<div class="mx-auto max-w-6xl">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold"><i class="fa-solid fa-wrench text-blue-600 mr-2"></i>Household Maintenance Log</h2>
        <button onclick="showAddTask()" class="btn btn-primary">
            <i class="fa-solid fa-plus mr-2"></i>Add Task
        </button>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="card p-4 bg-yellow-50 border-l-4 border-yellow-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Overdue</p>
                    <p class="text-2xl font-bold text-yellow-600">{{ tasks|selectattr('status', 'equalto', 'overdue')|list|length }}</p>
                </div>
                <i class="fa-solid fa-exclamation-triangle text-4xl text-yellow-500"></i>
            </div>
        </div>
        <div class="card p-4 bg-blue-50 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Due Soon</p>
                    <p class="text-2xl font-bold text-blue-600">{{ tasks|selectattr('status', 'equalto', 'upcoming')|list|length }}</p>
                </div>
                <i class="fa-solid fa-clock text-4xl text-blue-500"></i>
            </div>
        </div>
        <div class="card p-4 bg-green-50 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Completed This Month</p>
                    <p class="text-2xl font-bold text-green-600">{{ tasks|selectattr('status', 'equalto', 'completed')|list|length }}</p>
                </div>
                <i class="fa-solid fa-check-circle text-4xl text-green-500"></i>
            </div>
        </div>
    </div>

    <!-- Maintenance Tasks -->
    <div class="card p-6">
        <h3 class="text-xl font-bold mb-4">Maintenance Tasks</h3>
        <div class="space-y-3">
            {% for task in tasks %}
            <div class="card p-4 {% if task.status == 'overdue' %}bg-red-50 border-l-4 border-red-500{% elif task.status == 'upcoming' %}bg-yellow-50 border-l-4 border-yellow-500{% else %}bg-gray-50{% endif %}">
                <div class="flex flex-wrap items-start justify-between gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fa-solid fa-{{ task.icon or 'tools' }} text-lg"></i>
                            <h4 class="font-bold text-lg">{{ task.task_name }}</h4>
                            {% if task.status == 'overdue' %}
                            <span class="px-2 py-1 bg-red-600 text-white text-xs rounded-full">OVERDUE</span>
                            {% elif task.status == 'upcoming' %}
                            <span class="px-2 py-1 bg-yellow-600 text-white text-xs rounded-full">DUE SOON</span>
                            {% endif %}
                        </div>
                        <p class="text-sm text-gray-600 mb-2">{{ task.description or 'No description' }}</p>
                        <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                            <span><i class="fa-solid fa-calendar mr-1"></i>Next Due: {{ task.next_due.strftime('%b %d, %Y') if task.next_due else 'Not set' }}</span>
                            <span><i class="fa-solid fa-repeat mr-1"></i>Every {{ task.frequency_days }} days</span>
                            {% if task.last_completed %}
                            <span><i class="fa-solid fa-check mr-1"></i>Last Done: {{ task.last_completed.strftime('%b %d, %Y') }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="completeTask({{ task.id }})" class="btn bg-green-600 text-white">
                            <i class="fa-solid fa-check mr-1"></i>Mark Complete
                        </button>
                        <button onclick="deleteTask({{ task.id }})" class="btn btn-danger">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-12 text-gray-500">
                <i class="fa-solid fa-clipboard-list text-6xl mb-4"></i>
                <p>No maintenance tasks yet. Add some to keep track of your home upkeep!</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div id="taskModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg p-6 max-w-lg w-full">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">Add Maintenance Task</h3>
            <button onclick="document.getElementById('taskModal').classList.add('hidden')" class="text-gray-500 hover:text-gray-700">
                <i class="fa-solid fa-times text-2xl"></i>
            </button>
        </div>
        <form method="POST" action="/maintenance/add">
            <div class="mb-4">
                <label class="block font-semibold mb-2">Task Name</label>
                <input type="text" name="task_name" required class="w-full p-2 border rounded" placeholder="e.g., Change HVAC Filter">
            </div>
            <div class="mb-4">
                <label class="block font-semibold mb-2">Description (Optional)</label>
                <textarea name="description" class="w-full p-2 border rounded" rows="2" placeholder="Additional details..."></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block font-semibold mb-2">Icon</label>
                    <select name="icon" class="w-full p-2 border rounded">
                        <option value="tools">Tools</option>
                        <option value="fan">HVAC/Fan</option>
                        <option value="droplet">Water/Plumbing</option>
                        <option value="leaf">Lawn/Garden</option>
                        <option value="fire">Smoke Detector</option>
                        <option value="car">Vehicle</option>
                        <option value="lightbulb">Light Bulb</option>
                        <option value="filter">Filter</option>
                    </select>
                </div>
                <div>
                    <label class="block font-semibold mb-2">Frequency (Days)</label>
                    <input type="number" name="frequency_days" required class="w-full p-2 border rounded" placeholder="90" value="90">
                </div>
            </div>
            <div class="mb-4">
                <label class="block font-semibold mb-2">Next Due Date</label>
                <input type="date" name="next_due" required class="w-full p-2 border rounded">
            </div>
            <input type="hidden" name="creator" id="taskCreator">
            <div class="flex gap-2">
                <button type="submit" class="btn btn-primary flex-1">Add Task</button>
                <button type="button" onclick="document.getElementById('taskModal').classList.add('hidden')" class="btn flex-1">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('taskCreator').value = localStorage.getItem('username');

function showAddTask() {
    // Set default next due date to 90 days from now
    const input = document.querySelector('input[name="next_due"]');
    const date = new Date();
    date.setDate(date.getDate() + 90);
    input.value = date.toISOString().split('T')[0];
    document.getElementById('taskModal').classList.remove('hidden');
}

function completeTask(id) {
    fetch(`/maintenance/complete/${id}`, { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                if (window.globalToast) globalToast('Task marked as complete!', 'success');
                location.reload();
            }
        });
}

function deleteTask(id) {
    if (!confirm('Delete this maintenance task?')) return;

    const formData = new FormData();
    formData.append('user', localStorage.getItem('username'));

    fetch(`/maintenance/delete/${id}`, { method: 'POST', body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
}
</script>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<div class="mx-auto max-w-4xl">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold"><i class="fa-solid fa-cloud-sun text-sky-600 mr-2"></i>Weather</h2>
        <button onclick="refreshWeather()" class="btn btn-primary">
            <i class="fa-solid fa-rotate mr-2"></i>Refresh
        </button>
    </div>

    <!-- Location Input -->
    <div class="card p-6 mb-6">
        <div class="flex gap-2">
            <input type="text" id="locationInput" class="flex-1 p-3 border rounded-lg" placeholder="Enter city name or ZIP code..." value="{{ location or '' }}">
            <button onclick="updateLocation()" class="btn btn-primary px-6">
                <i class="fa-solid fa-search mr-2"></i>Search
            </button>
            <button onclick="useGeolocation()" class="btn" title="Use current location">
                <i class="fa-solid fa-location-crosshairs"></i>
            </button>
        </div>
    </div>

    <!-- Current Weather -->
    <div id="currentWeather" class="card p-8 mb-6 bg-gradient-to-br from-blue-400 to-sky-300 text-white">
        <div class="text-center mb-6">
            <h3 class="text-3xl font-bold mb-2" id="cityName">{{ weather.location if weather else 'Loading...' }}</h3>
            <p class="text-lg opacity-90" id="currentDate"></p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center">
                <i id="weatherIcon" class="fa-solid {{ weather.icon if weather else 'fa-cloud-sun' }} text-8xl mb-4"></i>
                <p class="text-xl font-semibold" id="weatherDesc">{{ weather.description if weather else '--' }}</p>
            </div>

            <div class="text-center">
                <p class="text-7xl font-bold" id="temperature">{{ weather.temp if weather else '--' }}°</p>
                <p class="text-lg mt-2">Feels like <span id="feelsLike">{{ weather.feels_like if weather else '--' }}°</span></p>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center bg-white bg-opacity-20 rounded-lg p-3">
                    <span><i class="fa-solid fa-droplet mr-2"></i>Humidity</span>
                    <span class="font-bold" id="humidity">{{ weather.humidity if weather else '--' }}%</span>
                </div>
                <div class="flex justify-between items-center bg-white bg-opacity-20 rounded-lg p-3">
                    <span><i class="fa-solid fa-wind mr-2"></i>Wind Speed</span>
                    <span class="font-bold" id="windSpeed">{{ weather.wind_speed if weather else '--' }} mph</span>
                </div>
                <div class="flex justify-between items-center bg-white bg-opacity-20 rounded-lg p-3">
                    <span><i class="fa-solid fa-gauge mr-2"></i>Pressure</span>
                    <span class="font-bold" id="pressure">{{ weather.pressure if weather else '--' }} mb</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 5-Day Forecast -->
    <div class="card p-6">
        <h3 class="text-xl font-bold mb-4">5-Day Forecast</h3>
        <div id="forecast" class="grid grid-cols-2 md:grid-cols-5 gap-4">
            {% if weather and weather.forecast %}
                {% for day in weather.forecast %}
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <p class="font-bold text-lg mb-2">{{ day.day }}</p>
                    <i class="fa-solid {{ day.icon }} text-4xl text-blue-500 mb-2"></i>
                    <p class="text-sm text-gray-600 mb-2">{{ day.description }}</p>
                    <div class="flex justify-center gap-2">
                        <span class="font-bold text-lg">{{ day.temp_high }}°</span>
                        <span class="text-gray-500">{{ day.temp_low }}°</span>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="text-center text-gray-500 col-span-full py-8">
                Enter a location to see the forecast
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Update current date
document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});

function updateWeatherDisplay(weather) {
    document.getElementById('cityName').textContent = weather.location;
    document.getElementById('temperature').textContent = weather.temp + '°';
    document.getElementById('feelsLike').textContent = weather.feels_like + '°';
    document.getElementById('humidity').textContent = weather.humidity + '%';
    document.getElementById('windSpeed').textContent = weather.wind_speed + ' mph';
    document.getElementById('pressure').textContent = weather.pressure + ' mb';
    document.getElementById('weatherDesc').textContent = weather.description;

    // Update weather icon
    const iconEl = document.getElementById('weatherIcon');
    iconEl.className = 'fa-solid ' + weather.icon + ' text-8xl mb-4';

    // Update forecast
    updateForecastDisplay(weather.forecast || []);
}

function updateForecastDisplay(forecast) {
    const forecastEl = document.getElementById('forecast');
    if (!forecast || forecast.length === 0) {
        forecastEl.innerHTML = '<div class="text-center text-gray-500 col-span-full py-8">No forecast data available</div>';
        return;
    }

    forecastEl.innerHTML = forecast.map(day => `
        <div class="text-center p-4 bg-gray-50 rounded-lg">
            <p class="font-bold text-lg mb-2">${day.day}</p>
            <i class="fa-solid ${day.icon} text-4xl text-blue-500 mb-2"></i>
            <p class="text-sm text-gray-600 mb-2">${day.description}</p>
            <div class="flex justify-center gap-2">
                <span class="font-bold text-lg">${day.temp_high}°</span>
                <span class="text-gray-500">${day.temp_low}°</span>
            </div>
        </div>
    `).join('');
}

function updateLocation() {
    const location = document.getElementById('locationInput').value;
    if (!location) {
        if (window.globalToast) globalToast('Please enter a location', 'error');
        return;
    }

    fetch('/weather/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ location })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success && data.weather) {
            updateWeatherDisplay(data.weather);
            if (window.globalToast) globalToast('Weather updated!', 'success');
        } else {
            if (window.globalToast) globalToast('Error: ' + (data.error || 'Could not fetch weather'), 'error');
        }
    })
    .catch(err => {
        if (window.globalToast) globalToast('Error fetching weather', 'error');
    });
}

function useGeolocation() {
    if (!navigator.geolocation) {
        if (window.globalToast) globalToast('Geolocation not supported by your browser', 'error');
        return;
    }

    if (window.globalToast) globalToast('Getting your location...', 'info');

    navigator.geolocation.getCurrentPosition(position => {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;

        fetch('/weather/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lat, lon })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success && data.weather) {
                updateWeatherDisplay(data.weather);
                document.getElementById('locationInput').value = data.weather.location;
                if (window.globalToast) globalToast('Weather updated for your location!', 'success');
            } else {
                if (window.globalToast) globalToast('Could not fetch weather for your location', 'error');
            }
        })
        .catch(err => {
            if (window.globalToast) globalToast('Error fetching weather', 'error');
        });
    }, (error) => {
        let errorMsg = 'Could not get your location';
        if (error.code === error.PERMISSION_DENIED) {
            errorMsg = 'Location permission denied. Please enable location access.';
        } else if (error.code === error.POSITION_UNAVAILABLE) {
            errorMsg = 'Location information unavailable';
        } else if (error.code === error.TIMEOUT) {
            errorMsg = 'Location request timed out';
        }
        if (window.globalToast) globalToast(errorMsg, 'error');
    });
}

function refreshWeather() {
    const location = document.getElementById('locationInput').value || '47725';
    if (location) {
        document.getElementById('locationInput').value = location;
        updateLocation();
    }
}

// Allow Enter key to search
document.getElementById('locationInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        updateLocation();
    }
});
</script>
{% endblock %}
